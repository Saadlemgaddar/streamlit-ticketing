{% extends "base.html" %}
{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
  /* Enhanced tile styling with modern design */
  .tile {
    border-radius: 20px;
    padding: 24px;
    background: #ffffff;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  
  .tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }
  
  .tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #c40000, #e05a5a);
    opacity: 0.8;
  }
  
  .tile h6 {
    margin: 0 0 1rem 0;
    font-weight: 700;
    color: #2d3748;
  }
  
  /* Enhanced tag design */
  .tag {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #c40000, #e05a5a);
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(196, 0, 0, 0.2);
  }
  
  .tag::before {
    content: 'üìä';
    margin-right: 6px;
    font-size: 0.9em;
  }

  /* Filter panel styling */
  .filter-panel {
    background: linear-gradient(135deg, #f7fafc, #edf2f7);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 32px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  }

  .filter-panel h5 {
    color: #2d3748;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
  }

  .filter-panel h5::before {
    content: 'üîç';
    margin-right: 8px;
    font-size: 1.2em;
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: end;
  }

  .filter-group {
    flex: 1;
    min-width: 200px;
  }

  .filter-group label {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 6px;
    display: block;
    font-size: 0.9rem;
  }

  .filter-group select,
  .filter-group input {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.9rem;
    background: #ffffff;
    transition: all 0.2s ease;
  }

  .filter-group select:focus,
  .filter-group input:focus {
    outline: none;
    border-color: #c40000;
    box-shadow: 0 0 0 3px rgba(196, 0, 0, 0.1);
  }

  .filter-actions {
    display: flex;
    gap: 12px;
    align-items: end;
    flex-shrink: 0;
  }

  .btn-filter {
    padding: 10px 20px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-apply {
    background: linear-gradient(135deg, #c40000, #e05a5a);
    color: white;
  }

  .btn-apply:hover {
    background: linear-gradient(135deg, #a30000, #c40000);
    transform: translateY(-1px);
  }

  .btn-reset {
    background: #f7fafc;
    color: #4a5568;
    border: 2px solid #e2e8f0;
  }

  .btn-reset:hover {
    background: #edf2f7;
    border-color: #c40000;
    color: #c40000;
  }

  .active-filters {
    margin-top: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-chip {
    background: #c40000;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .filter-chip .remove {
    cursor: pointer;
    font-weight: bold;
    opacity: 0.8;
  }

  .filter-chip .remove:hover {
    opacity: 1;
  }
  
  /* Chart container improvements */
  .chart-container {
    position: relative;
    margin-top: 12px;
  }
  
  /* Loading states */
  .chart-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 220px;
    color: #718096;
    font-style: italic;
  }
  
  .chart-loading::before {
    content: '‚è≥ ';
    margin-right: 8px;
  }
  
  /* Enhanced table styling */
  .table-actions {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  }
  
  .table-actions th {
    background: linear-gradient(135deg, #c40000, #a30000);
    color: #ffffff;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 16px;
    border: none;
    font-size: 0.9rem;
  }
  
  .table-actions tbody tr {
    transition: background-color 0.2s ease;
  }
  
  .table-actions tbody tr:hover {
    background-color: #fff8f8 !important;
    transform: scale(1.01);
  }
  
  .table-actions tbody tr:nth-child(odd) td {
    background: #fafafa;
  }
  
  .table-actions tbody tr:nth-child(even) td {
    background: #ffffff;
  }
  
  .table-actions td {
    padding: 14px 16px;
    border: none;
    font-weight: 500;
  }
  
  .table-actions tfoot th {
    background: #2d3748;
    color: #ffffff;
    font-weight: 700;
    padding: 16px;
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    .tile {
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .tag {
      font-size: 0.8rem;
      padding: 6px 12px;
    }
    
    .container-fluid {
      padding: 12px;
    }

    .filter-row {
      flex-direction: column;
    }

    .filter-group {
      min-width: auto;
    }

    .filter-actions {
      width: 100%;
      justify-content: center;
    }
  }
  
  /* Error state styling */
  .chart-error {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 220px;
    color: #e53e3e;
    font-style: italic;
    background: #fed7d7;
    border-radius: 8px;
    margin-top: 12px;
  }
  
  .chart-error::before {
    content: '‚ö†Ô∏è ';
    margin-right: 8px;
  }
  
  /* Animation for data updates */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .tile {
    animation: fadeInUp 0.6s ease forwards;
  }
  
  .tile:nth-child(1) { animation-delay: 0.1s; }
  .tile:nth-child(2) { animation-delay: 0.2s; }
  .tile:nth-child(3) { animation-delay: 0.3s; }
  .tile:nth-child(4) { animation-delay: 0.4s; }
  .tile:nth-child(5) { animation-delay: 0.5s; }

    .total-tickets-tile {
    background: linear-gradient(135deg, #c40000, #e05a5a);
    color: white;
    text-align: center;
  }

  .total-tickets-tile::before {
    background: rgba(255, 255, 255, 0.3);
  }

  .total-tickets-number {
    font-size: 3rem;
    font-weight: 900;
    line-height: 1;
    margin: 10px 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .total-tickets-label {
    font-size: 1.1rem;
    font-weight: 600;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

</style>

<div class="container-fluid">
<!-- Filter Panel -->
  <div class="filter-panel">
    <h5>Filtres Analytics</h5>
    
    <div class="filter-row">
      <div class="filter-group">
        <label for="filter-agent">Agent</label>
        <select id="filter-agent">
          <option value="">Tous les agents</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-canal">Canal</label>
        <select id="filter-canal">
          <option value="">Tous les canaux</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-thematique">Th√©matique</label>
        <select id="filter-thematique">
          <option value="">Toutes les th√©matiques</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-action">Action</label>
        <select id="filter-action">
          <option value="">Toutes les actions</option>
        </select>
      </div>
    </div>

    <div class="filter-row mt-3">
      <div class="filter-group">
        <label for="filter-magasin">Magasin</label>
        <select id="filter-magasin">
          <option value="">Tous les magasins</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-bu">BU</label>
        <select id="filter-bu">
          <option value="">Toutes les BU</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-date-from">Date de d√©but</label>
        <input type="date" id="filter-date-from">
      </div>
      
      <div class="filter-group">
        <label for="filter-date-to">Date de fin</label>
        <input type="date" id="filter-date-to">
      </div>
      
      <div class="filter-actions">
        <button class="btn-filter btn-apply" onclick="applyFilters()">
          Appliquer
        </button>
        <button class="btn-filter btn-reset" onclick="resetFilters()">
          R√©initialiser
        </button>
      </div>
    </div>

    <!-- Active filters display -->
    <div class="active-filters" id="active-filters"></div>
  </div>

  <!-- Charts Grid with Total Tickets Counter -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 d-flex justify-content-center">
      <div class="tile total-tickets-tile text-center mx-auto w-80">
        <div class="total-tickets-label">Total Tickets</div>
        <div class="total-tickets-number" id="total-tickets-count">-</div>
        <div style="font-size:0.9rem;opacity:.8;">tickets trait√©s</div>
      </div>
    </div>
  </div>

      
    <div class="row g-4">
    <div class="col-lg-4">
      <div class="tile">
        <div class="tag">TAUX DE CONTACTS PAR BU</div>
        <div class="chart-container">
          <div id="pieBU-loading" class="chart-loading">Chargement des donn√©es...</div>
          <canvas id="pieBU" height="220" style="display: none;" role="img" aria-label="Graphique circulaire montrant la r√©partition des contacts par Business Unit"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-lg-8">
      <div class="tile">
        <div class="tag">TRAITEMENT DES CONTACTS PAR TC</div>
        <div class="chart-container">
          <div id="barAgents-loading" class="chart-loading">Chargement des donn√©es...</div>
          <canvas id="barAgents" height="220" style="display: none;" role="img" aria-label="Graphique en barres montrant le nombre de contacts trait√©s par t√©l√©-conseiller"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-lg-5">
      <div class="tile">
        <div class="tag">R√âPARTITION DES CONTACTS PAR CANAL</div>
        <div class="chart-container">
          <div id="donutCanal-loading" class="chart-loading">Chargement des donn√©es...</div>
          <canvas id="donutCanal" height="240" style="display: none;" role="img" aria-label="Graphique en anneau montrant la r√©partition des contacts par canal de communication"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-lg-7">
      <div class="tile">
        <div class="tag">CONTACTS PAR TH√âMATIQUE</div>
        <div class="chart-container">
          <div id="barThem-loading" class="chart-loading">Chargement des donn√©es...</div>
          <canvas id="barThem" height="240" style="display: none;" role="img" aria-label="Graphique en barres montrant le nombre de contacts par th√©matique"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-12">
      <div class="tile">
        <div class="tag">ACTIONS / MONTANT</div>
        <div class="table-responsive mt-3">
          <table class="table table-actions align-middle" role="table" aria-label="Tableau des actions et montants associ√©s">
            <thead>
              <tr>
                <th scope="col">Actions</th>
                <th scope="col" class="text-end">Total code promo (MAD)</th>
              </tr>
            </thead>
            <tbody id="actionsBody">
              <tr>
                <td colspan="2" class="text-center py-4">
                  <span class="text-muted">‚è≥ Chargement des donn√©es...</span>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <th scope="row">Total g√©n√©ral</th>
                <th class="text-end" id="actionsTotal" aria-label="Montant total">0 MAD</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced Chart.js configuration and utilities
Chart.register(ChartDataLabels);

// Enhanced color palette with better accessibility
const COLORS = {
  primary: "#c40000",
  primarySoft: "#f2b6b6", 
  primaryMid: "#e05757",
  palette3: ["#c40000", "#e05a5a", "#f2b6b6"],
  palette8: ["#c40000", "#2b6cb0", "#ed8936", "#38a169", "#805ad5", "#718096", "#d53f8c", "#319795"],
  success: "#38a169",
  warning: "#ed8936",
  error: "#e53e3e",
  text: "#2d3748",
  textLight: "#718096"
};

// Global filter state
let currentFilters = {};
let filterOptions = {};

// Utility functions
const Utils = {
  formatNumber: (n) => n?.toLocaleString('fr-FR') || '0',
  formatCurrency: (n) => `${Utils.formatNumber(n)} MAD`,
  
  formatPercent: (value, context) => {
    const sum = context.dataset.data.reduce((a, b) => a + b, 0) || 1;
    const percentage = Math.round(100 * value / sum);
    return percentage >= 3 ? `${percentage}%` : "";
  },
  
  showLoading: (chartId) => {
    const loading = document.getElementById(`${chartId}-loading`);
    const canvas = document.getElementById(chartId);
    if (loading) loading.style.display = 'flex';
    if (canvas) canvas.style.display = 'none';
  },
  
  hideLoading: (chartId) => {
    const loading = document.getElementById(`${chartId}-loading`);
    const canvas = document.getElementById(chartId);
    if (loading) loading.style.display = 'none';
    if (canvas) canvas.style.display = 'block';
  },
  
  showError: (chartId, message = "Erreur lors du chargement des donn√©es") => {
    const loading = document.getElementById(`${chartId}-loading`);
    if (loading) {
      loading.className = 'chart-error';
      loading.textContent = message;
    }
  }
};

// Default chart options for consistency
const defaultChartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  interaction: {
    intersect: false,
    mode: 'index'
  },
  animation: {
    duration: 1000,
    easing: 'easeInOutQuart'
  }
};

// Chart instances to destroy before recreating
let chartInstances = {};

// Filter management functions - simplified
async function loadFilterOptions() {
  try {
    const response = await fetch("/analytics/api/filter_options");
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    filterOptions = await response.json();
    populateFilterDropdowns();
    
  } catch (error) {
    console.error('Erreur lors du chargement des options de filtres:', error);
  }
}

async function updateTotalCounter() {
  const queryString = buildQueryString();
  try {
    const res = await fetch(`/analytics/api/total?${queryString}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const totalEl = document.getElementById('total-tickets-count');
    totalEl.textContent = Utils.formatNumber(data.total || 0);
  } catch (e) {
    console.error('Erreur total:', e);
    document.getElementById('total-tickets-count').textContent = '-';
  }
}


function populateFilterDropdowns() {
  // Populate agents
  const agentSelect = document.getElementById('filter-agent');
  agentSelect.innerHTML = '<option value="">Tous les agents</option>';
  filterOptions.agents?.forEach(agent => {
    const option = document.createElement('option');
    option.value = agent;
    option.textContent = agent;
    agentSelect.appendChild(option);
  });

  // Populate canaux
  const canalSelect = document.getElementById('filter-canal');
  canalSelect.innerHTML = '<option value="">Tous les canaux</option>';
  filterOptions.canaux?.forEach(canal => {
    const option = document.createElement('option');
    option.value = canal;
    option.textContent = canal;
    canalSelect.appendChild(option);
  });

  // Populate thematiques
  const themSelect = document.getElementById('filter-thematique');
  themSelect.innerHTML = '<option value="">Toutes les th√©matiques</option>';
  filterOptions.thematiques?.forEach(them => {
    const option = document.createElement('option');
    option.value = them;
    option.textContent = them;
    themSelect.appendChild(option);
  });

  // Populate actions
  const actionSelect = document.getElementById('filter-action');
  actionSelect.innerHTML = '<option value="">Toutes les actions</option>';
  filterOptions.actions?.forEach(action => {
    const option = document.createElement('option');
    option.value = action;
    option.textContent = action;
    actionSelect.appendChild(option);
  });

  // Populate magasins
  const magasinSelect = document.getElementById('filter-magasin');
  magasinSelect.innerHTML = '<option value="">Tous les magasins</option>';
  filterOptions.magasins?.forEach(magasin => {
    const option = document.createElement('option');
    option.value = magasin;
    option.textContent = magasin;
    magasinSelect.appendChild(option);
  });

  // Populate BU
  const buSelect = document.getElementById('filter-bu');
  buSelect.innerHTML = '<option value="">Toutes les BU</option>';
  filterOptions.bus?.forEach(bu => {
    const option = document.createElement('option');
    option.value = bu;
    option.textContent = bu;
    buSelect.appendChild(option);
  });

  // Set date range limits
  if (filterOptions.date_range) {
    const dateFromInput = document.getElementById('filter-date-from');
    const dateToInput = document.getElementById('filter-date-to');
    
    if (filterOptions.date_range.min_date) {
      dateFromInput.min = filterOptions.date_range.min_date;
      dateFromInput.value = filterOptions.date_range.min_date;
    }
    if (filterOptions.date_range.max_date) {
      dateToInput.max = filterOptions.date_range.max_date;
      dateToInput.value = filterOptions.date_range.max_date;
    }
  }
}

function getFiltersFromForm() {
  return {
    agent: document.getElementById('filter-agent').value,
    canal: document.getElementById('filter-canal').value,
    thematique: document.getElementById('filter-thematique').value,
    action: document.getElementById('filter-action').value,
    magasin: document.getElementById('filter-magasin').value,
    bu: document.getElementById('filter-bu').value,
    date_from: document.getElementById('filter-date-from').value,
    date_to: document.getElementById('filter-date-to').value
  };
}

function resetFilters() {
  currentFilters = {};
  
  // Clear all form inputs
  document.getElementById('filter-agent').value = '';
  document.getElementById('filter-canal').value = '';
  document.getElementById('filter-thematique').value = '';
  document.getElementById('filter-action').value = '';
  document.getElementById('filter-magasin').value = '';
  document.getElementById('filter-bu').value = '';
  document.getElementById('filter-date-from').value = '';
  document.getElementById('filter-date-to').value = '';
  
  updateActiveFiltersDisplay();
  refreshAllCharts();
}

function applyFilters() {
  // lire le formulaire
  currentFilters = getFiltersFromForm();
  // retirer les valeurs vides
  Object.keys(currentFilters).forEach(k => { if (!currentFilters[k]) delete currentFilters[k]; });
  // rafra√Æchir l‚Äôaffichage et les donn√©es
  updateActiveFiltersDisplay();
  refreshAllCharts();
}

function updateActiveFiltersDisplay() {
  const container = document.getElementById('active-filters');
  container.innerHTML = '';
  
  Object.entries(currentFilters).forEach(([key, value]) => {
    if (value) {
      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      
      const labelMap = {
        agent: 'Agent',
        canal: 'Canal',
        thematique: 'Th√©matique',
        action: 'Action',
        magasin: 'Magasin',
        bu: 'BU',
        date_from: 'Depuis',
        date_to: 'Jusqu\'au'
      };
      
      chip.innerHTML = `
        <span>${labelMap[key] || key}: ${value}</span>
        <span class="remove" onclick="removeFilter('${key}')">√ó</span>
      `;
      
      container.appendChild(chip);
    }
  });
}
function removeFilter(filterKey) {
  delete currentFilters[filterKey];
  document.getElementById(`filter-${filterKey.replace('_', '-')}`).value = '';
  updateActiveFiltersDisplay();
  refreshAllCharts();
}

function buildQueryString() {
  const params = new URLSearchParams();
  Object.entries(currentFilters).forEach(([key, value]) => {
    if (value) params.append(key, value);
  });
  return params.toString();
}

// Enhanced chart drawing functions with filters
async function drawPieBU() {
  const chartId = 'pieBU';
  try {
    Utils.showLoading(chartId);
    const queryString = buildQueryString();
    const response = await fetch(`/analytics/api/by_bu?${queryString}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.labels || !data.values) {
      throw new Error("Format de donn√©es invalide");
    }
    
    Utils.hideLoading(chartId);
    
    // Destroy existing chart
    if (chartInstances[chartId]) {
      chartInstances[chartId].destroy();
    }
    
    chartInstances[chartId] = new Chart(document.getElementById(chartId), {
      type: "pie",
      data: {
        labels: data.labels,
        datasets: [{
          data: data.values,
          backgroundColor: COLORS.palette3,
          borderWidth: 2,
          borderColor: '#ffffff',
          hoverBorderWidth: 3,
          hoverOffset: 8
        }]
      },
      options: {
        ...defaultChartOptions,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12, weight: '600' }
            }
          },
          datalabels: {
            color: "#ffffff",
            font: { size: 14, weight: 'bold' },
            formatter: Utils.formatPercent,
            textShadowColor: 'rgba(0,0,0,0.3)',
            textShadowBlur: 2
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.label || '';
                const value = Utils.formatNumber(context.raw);
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.raw / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Erreur lors du chargement du graphique BU:', error);
    Utils.showError(chartId, "Impossible de charger les donn√©es BU");
  }
}

async function drawBarAgents() {
  const chartId = 'barAgents';
  try {
    Utils.showLoading(chartId);
    const queryString = buildQueryString();
    const response = await fetch(`/analytics/api/by_agent?${queryString}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();

    Utils.hideLoading(chartId);
    
    // Destroy existing chart
    if (chartInstances[chartId]) {
      chartInstances[chartId].destroy();
    }
    
    chartInstances[chartId] = new Chart(document.getElementById(chartId), {
      type: "bar",
      data: {
        labels: data.labels?.map(s => s.toUpperCase()) || [],
        datasets: [{
          label: "Contacts",
          data: data.values || [],
          backgroundColor: COLORS.primary,
          borderRadius: 6,
          borderSkipped: false,
          hoverBackgroundColor: COLORS.primaryMid
        }]
      },
      options: {
        ...defaultChartOptions,
        scales: {
          y: {
            grid: { color: "#f0f0f0", drawBorder: false },
            ticks: {
              callback: (value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : Utils.formatNumber(value),
              font: { size: 11 }
            }
          },
          x: {
            grid: { display: false },
            ticks: { font: { size: 11, weight: '600' } }
          }
        },
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: "end",
            align: "end",
            color: COLORS.primary,
            font: { size: 11, weight: 'bold' },
            formatter: (value, context) => {
              const percentage = data.pct?.[context.dataIndex];
              return percentage ? `${percentage.toFixed(1).replace(".", ",")}%` : "";
            }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = Utils.formatNumber(context.raw);
                const percentage = data.pct?.[context.dataIndex]?.toFixed(1) || '0';
                return `Contacts: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Erreur lors du chargement du graphique agents:', error);
    Utils.showError(chartId, "Impossible de charger les donn√©es agents");
  }
}

async function drawDonutCanal() {
  const chartId = 'donutCanal';
  try {
    Utils.showLoading(chartId);
    const queryString = buildQueryString();
    const response = await fetch(`/analytics/api/by_canal?${queryString}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    Utils.hideLoading(chartId);
    
    // Destroy existing chart
    if (chartInstances[chartId]) {
      chartInstances[chartId].destroy();
    }
    
    chartInstances[chartId] = new Chart(document.getElementById(chartId), {
      type: "doughnut",
      data: {
        labels: data.labels || [],
        datasets: [{
          data: data.values || [],
          backgroundColor: COLORS.palette8,
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverBorderWidth: 4,
          hoverOffset: 6
        }]
      },
      options: {
        ...defaultChartOptions,
        cutout: "60%",
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12, weight: '600' }
            }
          },
          datalabels: {
            color: "#ffffff",
            font: { size: 12, weight: 'bold' },
            formatter: Utils.formatPercent,
            textShadowColor: 'rgba(0,0,0,0.3)',
            textShadowBlur: 2
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.label || '';
                const value = Utils.formatNumber(context.raw);
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.raw / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Erreur lors du chargement du graphique canal:', error);
    Utils.showError(chartId, "Impossible de charger les donn√©es canal");
  }
}

async function drawBarThematiques() {
  const chartId = 'barThem';
  try {
    Utils.showLoading(chartId);
    const queryString = buildQueryString();
    const response = await fetch(`/analytics/api/by_thematique?${queryString}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    Utils.hideLoading(chartId);
    
    // Destroy existing chart
    if (chartInstances[chartId]) {
      chartInstances[chartId].destroy();
    }
    
    chartInstances[chartId] = new Chart(document.getElementById(chartId), {
      type: "bar",
      data: {
        labels: data.labels || [],
        datasets: [{
          label: "Contacts",
          data: data.values || [],
          backgroundColor: COLORS.primaryMid,
          borderRadius: 8,
          borderSkipped: false,
          hoverBackgroundColor: COLORS.primary
        }]
      },
      options: {
        ...defaultChartOptions,
        indexAxis: 'y',
        scales: {
          x: {
            grid: { color: "#f0f0f0", drawBorder: false },
            ticks: {
              callback: (value) => value >= 1000 ? `${(value / 1000).toFixed(1)}k` : Utils.formatNumber(value),
              font: { size: 11 }
            }
          },
          y: {
            grid: { display: false },
            ticks: { 
              font: { size: 11, weight: '600' },
              maxRotation: 0
            }
          }
        },
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: "end",
            align: "end",
            color: COLORS.primary,
            font: { size: 11, weight: 'bold' },
            formatter: (value, context) => {
              const percentage = data.pct?.[context.dataIndex];
              return percentage ? `${percentage.toFixed(1)}%` : "";
            }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = Utils.formatNumber(context.raw);
                const percentage = data.pct?.[context.dataIndex]?.toFixed(1) || '0';
                return `Contacts: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Erreur lors du chargement du graphique th√©matiques:', error);
    Utils.showError(chartId, "Impossible de charger les donn√©es th√©matiques");
  }
}

async function loadActionsTable() {
  try {
    const queryString = buildQueryString();
    const response = await fetch(`/analytics/api/actions_montant?${queryString}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const tbody = document.getElementById('actionsBody');
    const totalElement = document.getElementById('actionsTotal');
    
    if (!data.actions || !data.montants) {
      throw new Error("Format de donn√©es invalide pour le tableau actions");
    }
    
    // Clear existing content
    tbody.innerHTML = '';
    
    let total = 0;
    
    // Populate table rows
    data.actions.forEach((action, index) => {
      const montant = data.montants[index] || 0;
      total += montant;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${action}</td>
        <td class="text-end">${Utils.formatCurrency(montant)}</td>
      `;
      tbody.appendChild(row);
    });
    
    // Add empty state if no data
    if (data.actions.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="2" class="text-center py-4 text-muted">
          Aucune donn√©e disponible
        </td>
      `;
      tbody.appendChild(row);
    }
    
    // Update total
    totalElement.textContent = Utils.formatCurrency(total);
    
  } catch (error) {
    console.error('Erreur lors du chargement du tableau actions:', error);
    const tbody = document.getElementById('actionsBody');
    const totalElement = document.getElementById('actionsTotal');
    
    tbody.innerHTML = `
      <tr>
        <td colspan="2" class="text-center py-4 text-danger">
          ‚ö†Ô∏è Erreur lors du chargement des donn√©es
        </td>
      </tr>
    `;
    totalElement.textContent = '0 MAD';
  }
}

// Main functions to refresh all data
function refreshAllCharts() {
  // refresh the true total first
  updateTotalCounter();

  Promise.all([
    drawPieBU(),
    drawBarAgents(),
    drawDonutCanal(),
    drawBarThematiques(),
    loadActionsTable()
  ]).then(() => {
    console.log('Tous les graphiques ont √©t√© mis √† jour');
  }).catch(error => {
    console.error('Erreur lors de la mise √† jour des graphiques:', error);
  });
}

// Initialize dashboard
async function initDashboard() {
  try {
    // Load filter options first
    await loadFilterOptions();
    
    // Then load all charts
    await refreshAllCharts();
    
    console.log('Dashboard initialis√© avec succ√®s');
  } catch (error) {
    console.error('Erreur lors de l\'initialisation du dashboard:', error);
  }
}

// Add keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+Enter to apply filters
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    applyFilters();
  }
  
  // Ctrl+R to reset filters
  if (e.ctrlKey && e.key === 'r') {
    e.preventDefault();
    resetFilters();
  }
});

// Add form submission handling
document.addEventListener('DOMContentLoaded', () => {
  // Initialize dashboard
  initDashboard();
  
  // Add event listeners for Enter key on filter inputs
  document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyFilters();
      }
    });
  });
  
  // Auto-refresh every 5 minutes
  setInterval(() => {
    if (document.visibilityState === 'visible') {
      console.log('Auto-refresh des donn√©es...');
      refreshAllCharts();
    }
  }, 300000); // 5 minutes
});

// Handle visibility change for performance
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    // Refresh data when user returns to tab
    refreshAllCharts();
  }
});

// Export functionality for debugging
window.analyticsDebug = {
  currentFilters,
  chartInstances,
  refreshAllCharts,
  Utils,
  COLORS,
  filterOptions
};

// Error handling for unhandled promise rejections
window.addEventListener('unhandledrejection', event => {
  console.error('Unhandled promise rejection:', event.reason);
  event.preventDefault();
});

// Global error handler
window.addEventListener('error', event => {
  console.error('Global error:', event.error);
});



</script>

{% endblock %}