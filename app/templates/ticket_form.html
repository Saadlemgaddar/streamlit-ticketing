{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">{{ '‚ûï Cr√©er un ticket' if mode=='create' else '‚úèÔ∏è √âditer un ticket' }}</h4>

<form method="post" class="card card-body" id="ticketForm" novalidate>
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% if ticket_id %}<input type="hidden" name="id" value="{{ ticket_id }}">{% endif %}
  <input type="hidden" name="statut" value="Ouvert">

  <!-- ========== √âtape 0 : Info ==========- -->
  <h6 class="mb-2">Informations g√©n√©rales</h6>
  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label">Agent</label>
      <input class="form-control" value="{{ g.user.username if g.user else '' }}" disabled>
    </div>
    <div class="col-md-4">
      <label class="form-label">Date cr√©ation</label>
    <input class="form-control" value="{{ vals.get('date_creation', now.strftime('%Y-%m-%d %H:%M:%S')) }}" disabled></div>
    <div class="col-md-4">
      {% if mode == 'create' %}
        <label class="form-label">Statut</label>
        <input class="form-control" value="Ouvert" disabled>
        <input type="hidden" name="statut" value="Ouvert">
      {% else %}
        <label class="form-label">Statut</label>
        {% set s = (vals.get('statut') or 'Ouvert') %}
        <select name="statut" id="statutSel" class="form-select">
          <option value="Ouvert"  {{ 'selected' if s|lower in ['ouvert','open'] else '' }}>Ouvert</option>
          <option value="Cl√¥tur√©" {{ 'selected' if s|lower in ['cl√¥tur√©','clotur√©','clos','closed'] else '' }}>Cl√¥tur√©</option>
        </select>
      {% endif %}
    </div>
  </div>

  <div class="row g-2 mt-1">
    <div class="col-md-6">
      <label class="form-label">Nom et Pr√©nom client *</label>
      <input name="nom_prenom" class="form-control" placeholder="Ex: Dupont Jean" value="{{ vals.get('nom_prenom','') }}" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">ID Client</label>
      <input name="id_client" class="form-control" placeholder="CLI12345" value="{{ vals.get('id_client','') }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Num√©ro commande</label>
      <input name="num_cmd" class="form-control" placeholder="CMD67890" value="{{ vals.get('num_cmd','') }}">
    </div>
  </div>

  <div class="row g-2 mt-1">
    <div class="col-md-4">
      <label class="form-label">Canal *</label>
      <select name="canal" class="form-select" id="canalSel" required>
        <option value="">Choisir...</option>
        {% for c in canaux %}
          <option value="{{c}}" {{ 'selected' if vals.get('canal','')==c else '' }}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <hr class="my-3">

  <!-- ========== √âtape 1 : Magasin (must be first) ========== -->
  <h6 class="mb-2">√âTAPE 1 : S√âLECTION DU MAGASIN</h6>
  <div class="row g-2 align-items-end">
    <div class="col-md-6">
      <label class="form-label">Choisir le magasin *</label>
      <select class="form-select" id="magasinSelect" required>
        <option value="">-- S√©lectionner --</option>
      </select>
      <div class="form-text">‚ö†Ô∏è S√©lectionnez d'abord le magasin. Les √©tapes suivantes seront activ√©es automatiquement.</div>
    </div>
    <div class="col-md-6">
      <div class="alert alert-info py-2" id="magasinBadge" style="display:none;"></div>
    </div>
  </div>

  <!-- Hidden fields posted -->
  <input type="hidden" name="magasin" id="magasin" value="{{ vals.get('magasin','') }}">
  <input type="hidden" name="num_magasin" id="num_magasin" value="{{ vals.get('num_magasin','') }}">
  <input type="hidden" name="ville" id="ville" value="{{ vals.get('ville','') }}">
  <input type="hidden" name="bu" id="bu" value="{{ vals.get('bu','') }}">
  <input type="hidden" name="region" id="region" value="{{ vals.get('region','') }}">
  <input type="hidden" name="dr" id="dr" value="{{ vals.get('dr','') }}">
  <input type="hidden" name="dm" id="dm" value="{{ vals.get('dm','') }}">

  <hr class="my-3">

  <!-- ========== √âtape 2 : Cat√©gorisation (disabled until magasin) ========== -->
  <fieldset id="step2" disabled>
    <h6 class="mb-2">√âTAPE 2 : CAT√âGORISATION (cascade)</h6>
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Th√©matique *</label>
        <select class="form-select" name="thematique" id="sel_them" required></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Famille *</label>
        <select class="form-select" name="famille" id="sel_fam" required></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Sous Famille *</label>
        <select class="form-select" name="sous_famille" id="sel_sfam" required></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Cat√©gorie *</label>
        <select class="form-select" name="categorie" id="sel_cat" required></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Sous cat√©gorie *</label>
        <select class="form-select" name="sous_categorie" id="sel_scat" required></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Action *</label>
        <select class="form-select" name="action" id="sel_action" required></select>
      </div>
    </div>
  </fieldset>

  <hr class="my-3">

  <!-- ========== √âtape 3 : Traitement & montants (disabled until magasin) ========== -->
  <fieldset id="step3" disabled>
    <h6 class="mb-2">√âTAPE 3 : Traitement & montants</h6>
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Traitement *</label>
        <select name="traitement" class="form-select" id="traitementSel" required>
          {% for t in ['Normal','Exceptionnel'] %}
            <option value="{{t}}" {{ 'selected' if vals.get('traitement','Normal')==t else '' }}>{{t}}</option>
          {% endfor %}
        </select>
        <label class="form-label mt-2">Si exceptionnel, motif</label>
        <textarea name="si_exceptionnel" class="form-control" placeholder="Obligatoire si traitement exceptionnel">{{ vals.get('si_exceptionnel','') }}</textarea>
        <label class="form-label mt-2">Code promo appliqu√©</label>
        <input name="code_promo" class="form-control" value="{{ vals.get('code_promo','') }}" placeholder="Ex: CP-2025-XY">
      </div>
      <div class="col-md-4">
        <label class="form-label">Prix Produit(s) (MAD)</label>
        <input name="prix_pdts" type="number" step="0.01" class="form-control" value="{{ vals.get('prix_pdts',0) }}">
        <label class="form-label mt-2">Montant commande (MAD)</label>
        <input name="mnt_commande" type="number" step="0.01" class="form-control" value="{{ vals.get('mnt_commande',0) }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Montant remboursement (MAD)</label>
        <input name="mnt_rembour" id="mnt_rembour" type="number" step="0.01" class="form-control" value="{{ vals.get('mnt_rembour',0) }}">
        <label class="form-label mt-2">Geste commercial (MAD)</label>
        <input name="mnt_gestco" id="mnt_gestco" type="number" step="0.01" class="form-control" value="{{ vals.get('mnt_gestco',0) }}">
        <div class="mt-2 small">
          <span class="text-muted">Total code promo :</span>
          <strong id="totalPromo">0,00 MAD</strong>
        </div>
      </div>
    </div>
  </fieldset>

  <hr class="my-3">

  <!-- ========== √âtape 4 : Finalisation ========== -->
  <h6 class="mb-2">Finalisation</h6>
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label">Retour vers magasin</label>
      <textarea name="retour_magasin" class="form-control" placeholder="Instructions pour le magasin">{{ vals.get('retour_magasin','') }}</textarea>
    </div>
    <div class="col-md-6">
      <label class="form-label">Commentaires internes</label>
      <textarea name="commentaires" class="form-control" placeholder="Contexte, remarques, suivi...">{{ vals.get('commentaires','') }}</textarea>
    </div>
  </div>

<div class="mt-3 d-flex gap-2">
  <a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-light">Annuler</a>
  <button id="submitBtn" class="btn btn-primary">
    {{ 'üé´ Cr√©er le ticket' if mode=='create' else 'üíæ Enregistrer les modifications' }}
  </button>

  {% if mode == 'edit' and vals.get('statut','Ouvert')|lower in ['ouvert','open'] %}
    <button type="submit" name="cloturer" value="1" class="btn btn-danger">
      üîí Cl√¥turer
    </button>
  {% endif %}
</div>

</form>

<script>
const CSRF_TOKEN = "{{ csrf_token() }}";
const initialMagasin = "{{ vals.get('magasin','') }}";

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
function money(v){ const n = Number(v||0); return n.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' MAD'; }

function fillSelect(el, arr, current){
  const clean = Array.from(new Set((arr||[])
    .map(v => String(v ?? '').replace(/\s+/gu,' ').trim())
    .filter(v => v.length>0)));
  el.innerHTML = `<option value=""></option>` + clean.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  if(current){ const cur = String(current).replace(/\s+/gu,' ').trim(); if(clean.includes(cur)) el.value = cur; }
}

function setStepsEnabled(on){
  document.getElementById('step2').disabled = !on;
  document.getElementById('step3').disabled = !on;
}

function updateTotal(){
  const r = parseFloat(document.getElementById('mnt_rembour').value || 0);
  const g = parseFloat(document.getElementById('mnt_gestco').value || 0);
  document.getElementById('totalPromo').textContent = money(r+g);
}
['mnt_rembour','mnt_gestco'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', updateTotal);
});
updateTotal();

// ====== √âtape 1 : Magasins ======
let magasinsData = [];
(async ()=>{
  const res = await fetch("{{ url_for('tickets.api_magasins') }}", { headers:{'X-CSRFToken':CSRF_TOKEN} });
  magasinsData = await res.json(); // [{label, row}]
  const sel = document.getElementById('magasinSelect');
  fillSelect(sel, magasinsData.map(x=>x.label), initialMagasin);
  // Enable steps if magasin already present (edit mode)
  if (initialMagasin) { applyMagasin(initialMagasin); setStepsEnabled(true); }
  sel.addEventListener('change', (e)=>{
    const ok = !!e.target.value;
    applyMagasin(e.target.value);
    setStepsEnabled(ok);
    if (!ok) resetCascades();
  });
})();

function applyMagasin(label){
  document.getElementById('magasin').value = label || '';
  const item = magasinsData.find(x=>x.label===label);
  const badge = document.getElementById('magasinBadge');

  if(!item){
    badge.style.display='none';
    ['num_magasin','ville','bu','region','dr','dm'].forEach(id=>document.getElementById(id).value='');
    return;
  }
  const r = item.row || {};
  const num = (r['Code magasin']||r['code_magasin']||r['Num Magasin']||r['num_magasin']||'')+'';
  const ville = r['Ville']||r['ville']||'';
  const bu = r['BU']||r['bu']||'';
  const region = r['Region']||r['region']||'';
  const dr = r['DR']||r['dr']||'';
  const dm = r['DM']||r['dm']||'';

  document.getElementById('num_magasin').value = num;
  document.getElementById('ville').value = ville;
  document.getElementById('bu').value = bu;
  document.getElementById('region').value = region;
  document.getElementById('dr').value = dr;
  document.getElementById('dm').value = dm;

  badge.style.display='block';
  badge.textContent = `‚úÖ Magasin s√©lectionn√© : ${label}`;
}

// ====== √âtape 2 : Th√©matiques cascade ======
function resetCascades(){
  ['sel_them','sel_fam','sel_sfam','sel_cat','sel_scat','sel_action'].forEach(id=>fillSelect(document.getElementById(id), [], ''));
}

(async ()=>{
  // we only preload roots; the rest happens after magasin selection
  const themRes = await fetch("{{ url_for('tickets.api_thematiques_root') }}", { headers:{'X-CSRFToken':CSRF_TOKEN} });
  const thems = await themRes.json();
  fillSelect(document.getElementById('sel_them'), thems, "{{ vals.get('thematique','') }}");

  // if editing and a magasin exists, preload full cascade
  if (initialMagasin && "{{ vals.get('thematique','') }}"){
    await cascadeAfter({thematique: "{{ vals.get('thematique','') }}"}, 'sel_fam', "{{ vals.get('famille','') }}");
    await cascadeAfter({thematique: "{{ vals.get('thematique','') }}", famille:"{{ vals.get('famille','') }}"}, 'sel_sfam', "{{ vals.get('sous_famille','') }}");
    await cascadeAfter({thematique: "{{ vals.get('thematique','') }}", famille:"{{ vals.get('famille','') }}", sous_famille:"{{ vals.get('sous_famille','') }}"}, 'sel_cat', "{{ vals.get('categorie','') }}");
    await cascadeAfter({thematique: "{{ vals.get('thematique','') }}", famille:"{{ vals.get('famille','') }}", sous_famille:"{{ vals.get('sous_famille','') }}", categorie:"{{ vals.get('categorie','') }}"}, 'sel_scat', "{{ vals.get('sous_categorie','') }}");
    await cascadeAfter({thematique: "{{ vals.get('thematique','') }}", famille:"{{ vals.get('famille','') }}", sous_famille:"{{ vals.get('sous_famille','') }}", categorie:"{{ vals.get('categorie','') }}", sous_categorie:"{{ vals.get('sous_categorie','') }}"}, 'sel_action', "{{ vals.get('action','') }}");
  }

  document.getElementById('sel_them').addEventListener('change', async (e)=>{
    await cascadeAfter({thematique: e.target.value}, 'sel_fam', '');
    resetBelow('sel_fam');
  });
  document.getElementById('sel_fam').addEventListener('change', async (e)=>{
    await cascadeAfter({thematique: val('sel_them'), famille: e.target.value}, 'sel_sfam', '');
    resetBelow('sel_sfam');
  });
  document.getElementById('sel_sfam').addEventListener('change', async (e)=>{
    await cascadeAfter({thematique: val('sel_them'), famille: val('sel_fam'), sous_famille: e.target.value}, 'sel_cat', '');
    resetBelow('sel_cat');
  });
  document.getElementById('sel_cat').addEventListener('change', async (e)=>{
    await cascadeAfter({thematique: val('sel_them'), famille: val('sel_fam'), sous_famille: val('sel_sfam'), categorie: e.target.value}, 'sel_scat', '');
    resetBelow('sel_scat');
  });
  document.getElementById('sel_scat').addEventListener('change', async (e)=>{
    await cascadeAfter({thematique: val('sel_them'), famille: val('sel_fam'), sous_famille: val('sel_sfam'), categorie: val('sel_cat'), sous_categorie: e.target.value}, 'sel_action', '');
  });

  function val(id){ return (document.getElementById(id).value||''); }
  function resetBelow(id){
    const order = ['sel_them','sel_fam','sel_sfam','sel_cat','sel_scat','sel_action'];
    const idx = order.indexOf(id);
    order.slice(idx+1).forEach(x=> fillSelect(document.getElementById(x), [], ''));
  }
  async function cascadeAfter(params, targetId, currentVal){
    // If magasin not selected, do nothing (enforce flow)
    if (!document.getElementById('magasin').value) return;
    if(!params || Object.values(params).some(v=>!v)){ fillSelect(document.getElementById(targetId), [], ''); return; }
    const q = new URLSearchParams(params).toString();
    const res = await fetch("{{ url_for('tickets.api_thematiques_children') }}?"+q, { headers:{'X-CSRFToken':CSRF_TOKEN} });
    const data = await res.json();
    fillSelect(document.getElementById(targetId), data.values, currentVal);
  }
})();

// ====== Gentle client-side guard on submit ======
document.getElementById('ticketForm').addEventListener('submit', (e)=>{
  const requiredIds = ['magasin']; // magasin must be set
  const missing = requiredIds.filter(id => !document.getElementById(id).value);
  if (missing.length){ e.preventDefault(); alert('Veuillez s√©lectionner un magasin avant de soumettre.'); }
});
</script>
{% endblock %}
