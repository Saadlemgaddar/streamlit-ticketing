{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">üìã Gestion des tickets</h1>
  <div class="d-flex gap-2">
    <button id="btn_export_filtered" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-filter-circle me-1"></i>Exporter (filtr√©)
    </button>
    <a href="{{ url_for('tickets.export_csv') }}" class="btn btn-sm btn-primary">
      <i class="bi bi-download me-1"></i>Exporter tout (CSV)
    </a>
  </div>
</div>

<!-- Filtres -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-white border-0">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtres</h5>
      <button id="btn_reset" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-counterclockwise me-1"></i>R√©initialiser
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <!-- Date Range -->
      <div class="col-md-6">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label small text-muted">Date de d√©but</label>
            <input type="date" id="flt_dmin" class="form-control form-control-sm">
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Date de fin</label>
            <input type="date" id="flt_dmax" class="form-control form-control-sm">
          </div>
        </div>
      </div>

      <!-- Quick Filters -->
      <div class="col-md-6">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small text-muted">Agent</label>
            <select id="flt_agent" class="form-select form-select-sm">
              <option value="">Tous</option>
              {% for a in agents %}<option value="{{a}}">{{a}}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted">Statut</label>
            <select id="flt_statut" class="form-select form-select-sm">
              <option value="">Tous</option>
              {% for s in statuts %}<option value="{{s}}">{{s}}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted">Magasin</label>
            <select id="flt_mag" class="form-select form-select-sm">
              <option value="">Tous</option>
              {% for m in magasins %}<option value="{{m}}">{{m}}</option>{% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- Search and Theme -->
      <div class="col-md-8">
        <label class="form-label small text-muted">Recherche</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="flt_q" class="form-control" placeholder="ID, client, commande, commentaires...">
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label small text-muted">Th√©matique</label>
        <select id="flt_them" class="form-select form-select-sm">
          <option value="">Toutes</option>
          {% for t in thems %}<option value="{{t}}">{{t}}</option>{% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- R√©sum√© l√©ger -->
<div class="alert alert-light border d-flex flex-wrap justify-content-between align-items-center py-2 px-3 mb-3">
  <div class="d-flex align-items-center">
    <span class="badge bg-primary rounded-pill me-2" id="sumCount">0</span>
    <span class="small text-muted">tickets trouv√©s</span>
  </div>
</div>

<!-- Table Container avec header et footer fixes -->
<div class="card border-0 shadow-sm">
  <!-- Header fixe avec contr√¥les -->
  <div class="card-header bg-white border-bottom sticky-top" style="z-index: 10;">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted">Afficher</span>
        <div id="dtLengthHolder"></div>
        <span class="small text-muted">entr√©es</span>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <!-- Zone de scroll limit√©e au tableau -->
    <div class="table-responsive" id="tblWrap" style="max-height:60vh;overflow-y:auto;">
      <table id="ticketsTbl" class="table table-hover table-striped align-middle mb-0 dt-compact w-100">
        <thead class="table-light sticky-top">
          <tr>
            <th width="40"></th>
            <th width="40"></th>
            <th>ID</th>
            <th>Date</th>
            <th>Agent</th>
            <th class="d-none d-sm-table-cell">Client</th>
            <th class="d-none d-lg-table-cell">ID client</th>
            <th class="d-none d-lg-table-cell">N¬∞ commande</th>
            <th class="d-none d-md-table-cell">Magasin</th>
            <th class="d-none d-lg-table-cell">Th√©matique</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          {% set status = (r["statut"] or "") | lower %}
          <tr>
            <td class="text-center">
              <a href="{{ url_for('tickets.edit_ticket', id=r['id']) }}" class="btn btn-sm btn-outline-primary px-2 py-1" title="√âditer">
                <i class="bi bi-pencil"></i>
              </a>
            </td>
            <td class="text-center">
              <form action="{{ url_for('tickets.close_ticket', id=r['id']) }}" method="post" onsubmit="return confirm('Cl√¥turer le ticket {{ r['id'] }} ?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger px-2 py-1" title="Cl√¥turer"
                        {% if status in ['cl√¥tur√©','clotur√©','resolu','r√©solu'] %}disabled{% endif %}>
                  <i class="bi bi-lock"></i>
                </button>
              </form>
            </td>
            <td><span class="font-monospace">{{ r["id"] }}</span></td>

            <!-- Date: show pretty, keep ISO in data-ordervalue for filters/sort -->
            <td data-ordervalue="{{ r.get('date_iso','') or '' }}">
              <span class="small">{{ r["date_creation"] }}</span>
            </td>

            <td><span class="badge bg-light text-dark">{{ r["agent"] }}</span></td>
            <td class="d-none d-sm-table-cell text-truncate" style="max-width: 220px;">{{ r["nom_prenom"] }}</td>
            <td class="d-none d-lg-table-cell">{{ r["id_client"] }}</td>
            <td class="d-none d-lg-table-cell">{{ r["num_cmd"] }}</td>
            <td class="d-none d-md-table-cell">{{ r["magasin"] }}</td>
            <td class="d-none d-lg-table-cell">{{ r["thematique"] }}</td>
            <td>
              <span class="badge
                {% if status in ['nouveau','nouvelle'] %} bg-info
                {% elif status in ['en cours','en traitement'] %} bg-primary
                {% elif status in ['r√©solu','resolu','cl√¥tur√©','clotur√©'] %} bg-secondary
                {% elif status in ['urgent','prioritaire'] %} bg-danger
                {% else %} bg-light text-dark {% endif %}">
                {{ r["statut"] }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer fixe avec info et pagination -->
  <div class="card-footer bg-white border-top">
    <div class="d-flex justify-content-between align-items-center">
      <div class="small text-muted" id="dtInfoHolder"></div>
      <div class="d-flex align-items-center gap-2" id="dtPagingHolder"></div>
    </div>
  </div>
</div>

<!-- DataTables assets -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.3/js/dataTables.bootstrap5.js"></script>

<style>
  /* Density */
  .dt-compact tbody tr > * { padding-top:.35rem; padding-bottom:.35rem; }
  .dt-cozy    tbody tr > * { padding-top:.65rem; padding-bottom:.65rem; }

  /* Sticky header dans la zone de scroll */
  #tblWrap thead.sticky-top th {
    top: 0;
    z-index: 5;
    background: var(--bs-light) !important;
    border-bottom: 2px solid var(--bs-border-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Header de card fixe */
  .card-header.sticky-top {
    top: 0;
    background: white !important;
    border-bottom: 1px solid var(--bs-border-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Hover */
  #ticketsTbl tbody tr:hover { background: rgba(13,110,253,.06) !important; }

  /* Pagination buttons */
  .dataTables_wrapper .dataTables_paginate .paginate_button { 
    padding: .25rem .5rem !important; 
    margin: 0 2px;
  }
  .dataTables_wrapper .dataTables_info { padding-top: .35rem; }

  /* Scrollbar personnalis√©e */
  #tblWrap::-webkit-scrollbar {
    width: 8px;
  }
  #tblWrap::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  #tblWrap::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  #tblWrap::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Make sure only the table area scrolls */
  #tblWrap { 
    overscroll-behavior: contain;
  }

  /* Hide default DataTables elements */
  .dataTables_wrapper .dataTables_length,
  .dataTables_wrapper .dataTables_info,
  .dataTables_wrapper .dataTables_paginate {
    display: none;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const debounce = (fn, d=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d);} };

  // 1) Initialize DataTable avec DOM minimal
  const table = $('#ticketsTbl').DataTable({
    dom: "t", // Only table
    pagingType: 'full_numbers',
    pageLength: 25,
    lengthMenu: [[10,25,50,100,-1], ['10','25','50','100','Tous']],
    stateSave: true,
    deferRender: true,
    autoWidth: false,
    order: [[3,'desc']],
    columnDefs: [
      { orderable: false, targets: [0,1] },
      {
        targets: [3], // Date column
        render: function (data, type, row, meta) {
          if (type === 'sort' || type === 'type') {
            const td = table.cell(meta.row, meta.col).node();
            return td?.getAttribute('data-ordervalue') || data || '';
          }
          return data;
        }
      }
    ],
    language: {
      url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json",
      info: "Affichage de _START_ √† _END_ sur _TOTAL_",
      infoEmpty: "Aucune entr√©e",
      infoFiltered: "(filtr√© sur _MAX_ entr√©es au total)"
    }
  });

  // 2) Cr√©er nos propres contr√¥les
  createCustomControls();

  // Column indices 
  const COL = { ID:2, DATE:3, AGENT:4, CLIENT:5, IDCLIENT:6, NUMCMD:7, MAG:8, THEM:9, STATUT:10 };

  // External selects
  const bindSelect = (id, colIdx) => {
    const el = document.getElementById(id);
    el.addEventListener('change', () => {
      const val = el.value.trim();
      table.column(colIdx).search(val ? `^${escapeRegex(val)}$` : '', true, false).draw();
    });
  };
  bindSelect('flt_agent', COL.AGENT);
  bindSelect('flt_statut', COL.STATUT);
  bindSelect('flt_them', COL.THEM);
  bindSelect('flt_mag', COL.MAG);

  // Global search
  const glb = document.getElementById('flt_q');
  glb.addEventListener('input', debounce(e => table.search(e.target.value).draw(), 200));

  // Date range filter - FIXED VERSION
  const dminEl = document.getElementById('flt_dmin');
  const dmaxEl = document.getElementById('flt_dmax');
  
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    if (settings.nTable.id !== 'ticketsTbl') return true;
    
    const minStr = dminEl.value;
    const maxStr = dmaxEl.value;
    if (!minStr && !maxStr) return true;

    // R√©cup√©rer la date ISO depuis l'attribut data-ordervalue
    const td = table.cell(dataIndex, COL.DATE).node();
    let iso = td ? (td.getAttribute('data-ordervalue') || '').trim() : '';
    
    // Fallback: essayer de parser le texte visible
    if (!iso) {
      const txt = td ? td.textContent.trim() : '';
      iso = frToIso(txt);
    }
    
    if (!iso) return true;

    // Nettoyer l'ISO et cr√©er la date
    let cleanIso = iso;
    if (!iso.includes('T')) {
      cleanIso = iso.replace(' ', 'T');
    }
    
    const rowDate = new Date(cleanIso);
    if (isNaN(rowDate.getTime())) return true;

    // V√©rifier les limites
    if (minStr) {
      const min = new Date(minStr + 'T00:00:00');
      if (rowDate < min) return false;
    }
    if (maxStr) {
      const max = new Date(maxStr + 'T23:59:59');
      if (rowDate > max) return false;
    }
    return true;
  });

  // Event listeners pour les filtres de date
  ['change','input'].forEach(evt => {
    dminEl.addEventListener(evt, () => {
      console.log('Date filter changed:', dminEl.value, dmaxEl.value);
      table.draw();
    });
    dmaxEl.addEventListener(evt, () => {
      console.log('Date filter changed:', dminEl.value, dmaxEl.value);
      table.draw();
    });
  });

  // Reset filters
  document.getElementById('btn_reset').addEventListener('click', () => {
    ['flt_dmin','flt_dmax','flt_agent','flt_statut','flt_them','flt_mag','flt_q'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    table.search('');
    table.columns().every(function(){ this.search(''); });
    table.draw();
  });

  // Update count on draw
  table.on('draw.dt', () => {
    const count = table.rows({ search:'applied' }).indexes().length;
    document.getElementById('sumCount').textContent = String(count);
    updateCustomInfo();
  }).trigger('draw');

  // Export filtered
  document.getElementById('btn_export_filtered').addEventListener('click', () => {
    const idxs = table.rows({ search:'applied' }).indexes().toArray();
    if (!idxs.length) { alert('Aucune ligne √† exporter.'); return; }
    const header = ['ID','Date','Agent','Client','ID client','N¬∞ commande','Magasin','Th√©matique','Statut'];
    const lines = [header.join(',')];
    idxs.forEach(idx => {
      const cells = [COL.ID, COL.DATE, COL.AGENT, COL.CLIENT, COL.IDCLIENT, COL.NUMCMD, COL.MAG, COL.THEM, COL.STATUT]
        .map(c => {
          const td = table.cell(idx, c).node();
          const text = td ? td.textContent.trim() : '';
          return csvEscape(text);
        });
      lines.push(cells.join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: `tickets_${new Date().toISOString().slice(0,10)}.csv` });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Density toggle
  const tbl = document.getElementById('ticketsTbl');
  document.getElementById('btn_density_compact').addEventListener('click', (e) => {
    tbl.classList.add('dt-compact'); 
    tbl.classList.remove('dt-cozy');
    e.currentTarget.classList.add('active');
    document.getElementById('btn_density_cozy').classList.remove('active');
  });
  document.getElementById('btn_density_cozy').addEventListener('click', (e) => {
    tbl.classList.add('dt-cozy'); 
    tbl.classList.remove('dt-compact');
    e.currentTarget.classList.add('active');
    document.getElementById('btn_density_compact').classList.remove('active');
  });

  // Custom controls functions
  function createCustomControls() {
    // Length selector
    const lengthSelect = document.createElement('select');
    lengthSelect.className = 'form-select form-select-sm';
    lengthSelect.style.width = 'auto';
    lengthSelect.innerHTML = `
      <option value="10">10</option>
      <option value="25" selected>25</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="-1">Tous</option>
    `;
    lengthSelect.addEventListener('change', e => {
      table.page.len(parseInt(e.target.value, 10)).draw();
    });
    document.getElementById('dtLengthHolder').appendChild(lengthSelect);

    // Custom pagination
    createPagination();
  }

  function createPagination() {
    const paginationContainer = document.createElement('nav');
    paginationContainer.innerHTML = `
      <ul class="pagination pagination-sm mb-0" id="customPagination">
        <li class="page-item" id="page-first">
          <button class="page-link" onclick="goToPage('first')">Premi√®re</button>
        </li>
        <li class="page-item" id="page-prev">
          <button class="page-link" onclick="goToPage('prev')">Pr√©c√©dente</button>
        </li>
        <li class="page-item" id="page-next">
          <button class="page-link" onclick="goToPage('next')">Suivante</button>
        </li>
        <li class="page-item" id="page-last">
          <button class="page-link" onclick="goToPage('last')">Derni√®re</button>
        </li>
      </ul>
    `;
    document.getElementById('dtPagingHolder').appendChild(paginationContainer);
  }

  function updateCustomInfo() {
    const info = table.page.info();
    const infoText = info.recordsDisplay === 0 ? "Aucune entr√©e" :
      `Affichage de ${info.start + 1} √† ${info.end} sur ${info.recordsDisplay} ${info.recordsTotal !== info.recordsDisplay ? `(filtr√© sur ${info.recordsTotal} entr√©es au total)` : ''}`;
    document.getElementById('dtInfoHolder').textContent = infoText;
    
    // Update pagination buttons
    document.getElementById('page-first').classList.toggle('disabled', info.page === 0);
    document.getElementById('page-prev').classList.toggle('disabled', info.page === 0);
    document.getElementById('page-next').classList.toggle('disabled', info.page >= info.pages - 1);
    document.getElementById('page-last').classList.toggle('disabled', info.page >= info.pages - 1);
  }

  // Global functions for pagination
  window.goToPage = function(direction) {
    switch(direction) {
      case 'first': table.page('first'); break;
      case 'prev': table.page('previous'); break;
      case 'next': table.page('next'); break;
      case 'last': table.page('last'); break;
    }
    table.draw('page');
  };

  // Utils
  function csvEscape(s){
    const needs = /[",\n]/.test(s);
    let out = s.replaceAll('"','""');
    return needs ? `"${out}"` : out;
  }
  function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function frToIso(txt){
    const m = txt.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
    if (!m) return "";
    const [_, d, mo, y, h, mi, s] = m;
    return `${y}-${mo}-${d}T${h}:${mi}:${s||"00"}`;
  }
});
</script>

{% endblock %}